@using Umbraco.Cms.Web.Common.PublishedModels;
@using Umbraco.Cms.Core.Models.PublishedContent;
@using Umbraco.Cms.Core.Models;
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

<link rel="stylesheet" href="/css/CategoryStyle.css" />

<head>
    <title>@Model.Name</title>
</head>

@{
    Layout = "master.cshtml";

    var currentCategory = Model;
    var programsRoot = Model.Root().DescendantsOrSelf("programs").FirstOrDefault();

    IEnumerable<IPublishedContent> filteredPrograms = Enumerable.Empty<IPublishedContent>();

    if (programsRoot != null)
    {
        var allPrograms = programsRoot.DescendantsOfType("program").ToList();

        filteredPrograms = allPrograms.Where(p =>
        {
            var categories = p.Value<IEnumerable<Link>>("category");
            return categories != null && categories.Any(c => c.Url == currentCategory.Url());
        }).ToList();
    }

    int itemsPerPage = 20;
    int totalItems = filteredPrograms.Count();
    int totalPages = (int)Math.Ceiling(totalItems / (double)itemsPerPage);

    int currentPage = 1;
    var pageQuery = Context.Request.Query["page"];
    if (!string.IsNullOrEmpty(pageQuery) && int.TryParse(pageQuery, out int page))
    {
        currentPage = Math.Clamp(page, 1, totalPages);
    }

    var programsPage = filteredPrograms
    .Skip((currentPage - 1) * itemsPerPage)
    .Take(itemsPerPage)
    .ToList();
}

@if (!programsPage.Any())
{
    <h1 class="text-center mt-2">@currentCategory.Name</h1>
    <p>לא נמצאו תכניות לקטגוריה זו.</p>
}
else
{
    <h1 class="category-title text-center mt-2">@currentCategory.Name</h1>
    <div class="programs-grid">
        @foreach (var program in programsPage)
        {
            var img = program.Value<IPublishedContent>("squareImage");
            var imgUrl = img != null ? img.Url() : "/path/to/placeholder.jpg";

            <div class="program-card text-center">
                <a href="@program.Url()">
                    <img src="@imgUrl" alt="@program.Name" />
                    <h5>@program.Name</h5>
                </a>
            </div>
        }
    </div>
}

@if (totalPages > 1)
{
    <div class="pagination">
        @for (int i = 1; i <= totalPages; i++)
        {
            if (i == currentPage)
            {
                <span class="current">@i</span>
            }
            else
            {
                <a href="?page=@i">@i</a>
            }
        }
    </div>
}
