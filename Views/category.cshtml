@using Umbraco.Cms.Web.Common.PublishedModels;
@using Umbraco.Cms.Core.Models.PublishedContent
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

<link rel="stylesheet" href="/css/CategoryStyle.css"/>

@{
    Layout = "master.cshtml";

    var currentCategory = Model;
    var programsRoot = Model.Root().DescendantsOrSelf("programs").FirstOrDefault();

    List<string> debugMessages = new();
    IEnumerable<IPublishedContent> filteredPrograms = Enumerable.Empty<IPublishedContent>();

    if (programsRoot == null)
    {
        debugMessages.Add("❌ לא נמצא nodes בשם 'programs'. ודא שקיים Node כזה בעץ התוכן.");
    }
    else
    {
        var allPrograms = Model.Root().DescendantsOfType("programs").ToList();

        if (!allPrograms.Any())
        {
            debugMessages.Add("❌ לא נמצאו תכניות תחת 'programs'.");
        }
        else
        {
            // הדפסת כל התכניות והקטגוריות שלהן (ברשימת ה-Multi Picker)
            foreach (var p in allPrograms)
            {
                // Multi Picker מחזיר רשימה של IPublishedContent
                var categories = p.Value<IEnumerable<IPublishedContent>>("Category");
                if (categories != null && categories.Any())
                {
                    var catNames = string.Join(", ", categories.Select(c => $"{c.Name} (ID: {c.Id})"));
                    debugMessages.Add($"תוכנית: {p.Name} | קטגוריות מקושרות: {catNames}");
                }
                else
                {
                    debugMessages.Add($"תוכנית: {p.Name} | אין קטגוריה");
                }
            }

            // סינון לפי קטגוריה נוכחית - תכניות שיש להן לפחות קטגוריה אחת שמתאימה לקטגוריה הנוכחית
            filteredPrograms = allPrograms.Where(p =>
            {
                var categories = p.Value<IEnumerable<IPublishedContent>>("Category");
                return categories != null && categories.Any(c => c.Id == currentCategory.Id);
            }).ToList();

            if (!filteredPrograms.Any())
            {
                debugMessages.Add($"❌ לא נמצאו תכניות עם קטגוריה תואמת (קטגוריה נוכחית: {currentCategory.Name}, ID: {currentCategory.Id}).");
            }
        }
    }

    int itemsPerPage = 20;
    int totalItems = filteredPrograms.Count();
    int totalPages = (int)Math.Ceiling(totalItems / (double)itemsPerPage);

    int currentPage = 1;
    var pageQuery = Context.Request.Query["page"];
    if (!string.IsNullOrEmpty(pageQuery) && int.TryParse(pageQuery, out int page))
    {
        currentPage = Math.Clamp(page, 1, totalPages);
    }

    var programsPage = filteredPrograms
        .Skip((currentPage - 1) * itemsPerPage)
        .Take(itemsPerPage)
        .ToList();
}

<h1 class="text-center mt-2">@currentCategory.Name</h1>

<!-- הדפסות דיבאג -->
<div style="background:#f3f3f3; border:1px solid #ccc; padding:10px; margin-bottom:15px;">
    <h4>Debug Info:</h4>
    <ul>
        @foreach (var msg in debugMessages)
        {
            <li>@msg</li>
        }
    </ul>
</div>

@if (!programsPage.Any())
{
    <p>לא נמצאו תכניות לקטגוריה זו.</p>
}
else
{
    <div class="programs-grid">
        @foreach(var program in programsPage)
        {
            var img = program.Value<IPublishedContent>("squareImage");
            var imgUrl = img != null ? img.Url() : "/path/to/placeholder.jpg";

            <div class="program-card">
                <a href="@program.Url()">
                    <img src="@imgUrl" alt="@program.Name" />
                    <div>@program.Name</div>
                </a>
            </div>
        }
    </div>
}

@if (totalPages > 1)
{
    <div class="pagination">
        @for (int i = 1; i <= totalPages; i++)
        {
            if (i == currentPage)
            {
                <span class="current">@i</span>
            }
            else
            {
                <a href="?page=@i">@i</a>
            }
        }
    </div>
}
