@using Umbraco.Cms.Core.Models.PublishedContent
@using Umbraco.Cms.Core.Models
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

@{
    Layout = "master.cshtml";

    var episodeName = Model.Value<string>("episodeTitle");
    var episodeDescription = Model.Value<string>("episodeDescription");

    var videoLinks = Model.Value<IEnumerable<Link>>("linkUrl");
    var episodeVideoUrl = videoLinks?.FirstOrDefault()?.Url;

    if (!string.IsNullOrWhiteSpace(episodeVideoUrl) && episodeVideoUrl.Contains("youtube.com/watch"))
    {
        var videoId = "";
        var startTime = "";

        var uri = new Uri(episodeVideoUrl);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

        if (!string.IsNullOrEmpty(query["v"]))
        {
            videoId = query["v"];
        }

        if (!string.IsNullOrEmpty(query["t"]))
        {
            var tValue = query["t"].Replace("s", "");
            startTime = $"?start={tValue}";
        }

        episodeVideoUrl = $"https://www.youtube.com/embed/{videoId}{startTime}";
    }


    var parentProgram = Model.Parent;
    var otherEpisodes = parentProgram.ChildrenOfType("EpisodePage").Where(e => e.Id != Model.Id);
}

<section class="episode-section">
    @if (!string.IsNullOrWhiteSpace(episodeVideoUrl))
    {
        <div class="video-container">
            <h1 class="text-center mb-4">@episodeName</h1>
            <iframe src="@episodeVideoUrl" frameborder="0" allowfullscreen></iframe>
        </div>
    }

    <p style="text-align: right; direction: RTL;">@Html.Raw(episodeDescription)</p>

    <hr />

    @if(otherEpisodes != null){
        <h2 style="direction: RTL;">מוזמנים לצפות גם בפרקים נוספים:</h2>
        <div class="episodes-grid" >
            @foreach (var ep in otherEpisodes)
            {
                var epImage = ep.Value<IPublishedContent>("imageEpisode")?.Url();
                <div class="episode-card">
                    <a href="@ep.Url()">
                        <img src="@epImage" alt="@ep.Name" loading="lazy" />
                        <h3>@ep.Value("episodeTitle")</h3>
                    </a>
                </div>
            }
        </div>
    }
</section>

<style>
    body{
        background-color: lightblue;
    }
    .episode-section {
        padding: 40px;
        color: white;
    }

    .video-container {
        max-width: 800px;
        margin: 0 auto 20px;
    }

    .video-container iframe {
        width: 100%;
        height: 450px;
        border-radius: 10px;
        box-shadow: 0 20px 20px rgba(0, 0, 0, 0.2);
    }

    h2 {
        text-align: right;
        color:black;
        margin-top: 10px;
        font-size: 30px;
    }

    .episodes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
        direction: RTL;
    }

    .episode-card {
        background: #222;
        border-radius: 10px;
        overflow: hidden;
        text-align: center;
        transition: transform 0.3s;
    }

    .episode-card:hover {
        transform: scale(1.05);
    }

    .episode-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        transition: opacity 0.4s ease-in-out;
        opacity: 0;
    }

    .episode-card img[loading="lazy"] {
        opacity: 1;
    }

    .episode-card h3 {
        color: white;
        margin: 10px;
        font-size: 18px;
    }
</style>
