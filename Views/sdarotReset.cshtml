@using System.Xml.Linq
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    body {
        background-color: lightskyblue;
    }

    .banner-image {
        width: 100%;
        height: 50%;
        object-fit: cover;
        border-radius: 2px;
        box-shadow: 10px 8px 15px rgba(0, 0, 0, 0.3);
    }

    .richtext-container {
        text-align: right;
        white-space: normal;
        word-wrap: break-word;
    }

    .episode-card {
        //border: 1px solid #ccc;
        padding: 10px;
        opacity: 0;
        transform: translateY(15px);
        transition: opacity 0.5s ease, transform 0.5s ease;
    }

    .episode-card.show {
        opacity: 1;
        transform: translateY(0);
    }

    #load-more {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 24px;
        color: blue;
    }
</style>

@functions {
    public class Episode
    {
        public string Title { get; set; }
        public string PubDate { get; set; }
        public string Image { get; set; }
        public string AudioUrl { get; set; }
    }
}

@{
    Layout = "master.cshtml";

    var rssLinks = Model.Value<IEnumerable<Umbraco.Cms.Core.Models.Link>>("rssLink2");
    var rssUrl = rssLinks?.FirstOrDefault()?.Url;

    if (string.IsNullOrEmpty(rssUrl))
    {
        <p style="color:red;">לא הוגדר קישור RSS בעמוד זה.</p>
        return;
    }

    List<Episode> episodes = new List<Episode>();

    using (var client = new System.Net.WebClient())
    {
        try
        {
            var xml = client.DownloadString(rssUrl);
            var doc = XDocument.Parse(xml);
            var items = doc.Descendants("item");

            episodes = items.Select(item => new Episode
            {
                Title = item.Element("title")?.Value,
                PubDate = item.Element("pubDate")?.Value,
                Image = item.Descendants().FirstOrDefault(x => x.Name.LocalName == "image")?.Attribute("href")?.Value,
                AudioUrl = item.Element("enclosure")?.Attribute("url")?.Value
            }).ToList();
        }
        catch (Exception ex)
        {
            <p style="color:red;">שגיאה בטעינת ה-RSS: @ex.Message</p>
        }
    }

    var bannerImage = Model.Value<IPublishedContent>("rectangleImage");
    var bannerUrl = bannerImage?.Url();

    var dis = Model.Value<string>("discreption");
}

@if (!string.IsNullOrWhiteSpace(bannerUrl))
{
    <div class="banner-container">
        <img src="@bannerUrl" alt="Banner" class="banner-image" />
    </div>
}

<h1 class="m-3" style="text-align: right;">@Model.Name</h1>

<div class="m-3 richtext-container" style="text-align:right; direction: rtl">
    @dis
</div>

<h1 style="text-align: right; direction: rtl" class="m-3">התכניות האחרונות ששודרו :</h1>

@if (!episodes.Any())
{
    <p>לא נמצאו פרקים להצגה.</p>
}
else
{
    <div id="episodes-container"
         style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
        @foreach (var episode in episodes.Take(8))
        {
            var dateString = episode.PubDate;
            DateTime pubDate;
            var formattedDate = DateTime.TryParse(dateString, out pubDate)
                ? pubDate.ToString("dd.MM.yy")
                : dateString;

            <div class="episode-card">
                @if (!string.IsNullOrEmpty(episode.Image))
                {
                    <img src="@episode.Image" alt="@episode.Title" style="width: 100%; height: auto; border-radius: 8px;" />
                }
                <h4 style="text-align:right;">@episode.Title</h4>
                <h5 style="text-align:right;">@formattedDate</h5>
            </div>
        }
    </div>

    @if (episodes.Count > 8)
    {
        <div style="text-align:center; margin-top:20px;">
            <p style="margin-bottom:5px; font-size:18px;">טען עוד</p>
            <button id="load-more">
                <i class="fa-solid fa-angle-down"></i>
            </button>
        </div>
    }
}

<script>
    const allEpisodes = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(episodes));
    let displayedCount = 8;

    // אפקט אנימציה לפרקים הראשונים
    document.querySelectorAll('.episode-card').forEach((card, index) => {
        setTimeout(() => card.classList.add('show'), 50 * (index + 1));
    });

    document.getElementById('load-more')?.addEventListener('click', function () {
        const container = document.getElementById('episodes-container');
        const nextEpisodes = allEpisodes.slice(displayedCount, displayedCount + 8);

        nextEpisodes.forEach((ep, index) => {
            const pubDate = new Date(ep.PubDate);
            const formattedDate = !isNaN(pubDate)
                ? pubDate.toLocaleDateString('he-IL')
                : ep.PubDate;

            const card = document.createElement('div');
            card.classList.add('episode-card');
            card.innerHTML = `
                ${ep.Image ? `<img src="${ep.Image}" alt="${ep.Title}" style="width: 100%; height: auto; border-radius: 8px;" />` : ''}
                <h4 style="text-align:right;">${ep.Title}</h4>
                <h5 style="text-align:right;">${formattedDate}</h5>
            `;

            container.appendChild(card);

            // אנימציה עם עיכוב קטן
            setTimeout(() => card.classList.add('show'), 50 * (index + 1));
        });

        displayedCount += 8;

        if (displayedCount >= allEpisodes.length) {
            document.getElementById('load-more').style.display = 'none';
        }
    });
</script>
