@using System.Xml.Linq
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Assistant:wght@200..800&display=swap" rel="stylesheet">

<style>
  body {
    margin: 0;
    padding: 0;
    background-color: #fff;
    color: #333;
  }

  .banner-container {
    position: relative;
    width: 100%;
    height: 400px;
  }

  .banner-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    box-shadow: 10px 10px 20px rgba(0, 0, 0, 0.3);
  }

  .program-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 20px;
    direction: rtl;
  }

  .program-title {
    display: flex;
    align-items: center;
    gap: 15px;
    font-family: Arial, sans-serif;
  }

  .program-title h1 {
    margin: 0;
    font-size: 32px;
    font-weight: bold;
    font-family: Arial, sans-serif;
  }

  .share-btn {
    font-size: 24px;
    cursor: pointer;
    color: #333;
  }

  .spotify-section {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .spotify-qr {
    width: 60px;
    height: 60px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #f9f9f9;
    background-size: cover;
    background-position: center;
  }

  .spotify-text {
    font-size: 14px;
    color: #333;
  }

  .richtext-container {
    text-align: right;
    direction: rtl;
    margin: 0 20px 30px 20px;
    font-size: 18px;
    color: #444;
    font-family: Arial, sans-serif;
  }

  .episode-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin: 0 20px;
  }

  .episode-card {
    display: flex;
    align-items: center;
    flex-direction: row-reverse;
    justify-content: space-between;
    border-bottom: 1px solid #ddd;
    padding: 15px 0;
    opacity: 0;
    transform: translateY(15px);
    transition: opacity 0.5s ease, transform 0.5s ease;
  }

  .episode-card.show {
    opacity: 1;
    transform: translateY(0);
  }

  .episode-image-container {
    position: relative;
    width: 200px;
    height: 200px;
    flex-shrink: 0;
    border-radius: 5px;
    overflow: hidden;
    margin-left: 15px;
  }

  .episode-image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .play-button {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 50px;
    color: white;
    background: rgba(0, 0, 0, 0.6);
    border-radius: 50%;
    padding: 5px;
    text-decoration: none;
  }

  .episode-info {
    flex: 1;
    text-align: right;
    direction: rtl;
    margin-right: 10px;
    font-family: Arial, sans-serif;
  }

  .episode-info h4 {
    margin: 0;
    font-size: 30px;
    font-weight: bold;
    font-family: Arial, sans-serif;
  }

  .episode-info p.description {
    margin: 5px 0;
    font-size: 20px;
    color: #666;
    font-family: Arial, sans-serif;
  }

  .episode-info .date {
    font-size: 15px;
    color: #aaa;
    font-family: Arial, sans-serif;
  }

  #load-more {
    background-color: transparent;
    color: black;
    font-size: 30px;
    border: none;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    margin: 40px auto;
    text-align: center;
  }

  #load-more i {
    font-size: 20px;
    background-color: #092782;
    border-radius: 50%;
    padding: 12px;
    color: #ffe666;
    transition: background 0.3s ease;
  }

  #load-more:hover i {
    background-color: #001f66;
  }

  .tooltip-container {
    position: relative;
    display: inline-block;
  }

  .button-content {
    display: flex;
    align-items: center;
    background-color: #007bff;
    color: white;
    padding: 10px 14px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.3s;
  }

  .button-content:hover {
    background-color: #0056b3;
  }

  .text {
    margin-right: 8px;
    font-weight: bold;
  }

  .share-icon {
    fill: white;
  }

  .tooltip-content {
    position: absolute;
    top: calc(100% + 12px);
    /* מתחת לכפתור עם מרווח */
    left: 50%;
    transform: translateX(-50%);
    background-color: #fff;
    padding: 12px 16px;
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    z-index: 999;
    display: none;
    min-width: 160px;
    text-align: center;
  }

  /* שפיץ */
  .tooltip-arrow {
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-bottom: 8px solid white;
  }

  .social-icons {
    display: flex;
    justify-content: space-around;
    gap: 15px;
  }

  .social-icon {
    color: #333;
    font-size: 24px;
    transition: transform 0.2s, color 0.2s;
    text-decoration: none;
  }

  .social-icon:hover {
    transform: scale(1.3);
  }

  .social-icon.twitter:hover {
    color: #1DA1F2;
  }

  .social-icon.facebook:hover {
    color: #3b5998;
  }

  .social-icon.whatsapp:hover {
    color: #25D366;
  }

  hr {
    border: none;
    /* לא מציג גבול ברירת מחדל */
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    /* קו דק */
    margin: 1.2rem 0;
    /* רווח מעל ומתחת */
    height: 1px;
    /* גובה הקו */
    background: transparent;
    /* רקע שקוף */
    overflow: visible;
  }

  #favorite-icon {
    color: black;
    /* ברירת מחדל */
    transition: color 0.3s;
  }

  #favorite-icon.favorited {
    color: #ff4d4d;
    /* אדום בהיר */
  }
</style>

@functions {
  public class Episode
  {
    public string Title { get; set; }
    public string Description { get; set; }
    public string PubDate { get; set; }
    public string Image { get; set; }
    public string AudioUrl { get; set; }
    public string Guid { get; set; }
    public int ProgramId { get; set; }
  }

  public string CleanDescription(string html)
  {
    if (string.IsNullOrEmpty(html)) return "";
    var plain = System.Text.RegularExpressions.Regex.Replace(html, "<.*?>", ""); // הסרת HTML
    var firstLine = plain.Split(new[] { "\r\n", "\r", "\n" }, StringSplitOptions.None).FirstOrDefault() ?? plain;
    return firstLine.Length > 100 ? firstLine.Substring(0, 100) + "..." : firstLine;
  }

  public string FormatDescription(string html)
  {
    if (string.IsNullOrEmpty(html)) return "";

    var plain = System.Text.RegularExpressions.Regex.Replace(html, "<.*?>", ""); // הסרת HTML
    var sentences = plain.Split(new[] { '.' }, StringSplitOptions.RemoveEmptyEntries);

    return string.Join(".<br>", sentences.Select(s => s.Trim())) + ".";
  }

}

@{
  Layout = "master.cshtml";

  var rssLinks = Model.Value<IEnumerable<Umbraco.Cms.Core.Models.Link>>("rssLink2");
  var rssUrl = rssLinks?.FirstOrDefault()?.Url;

  if (string.IsNullOrEmpty(rssUrl))
  {
    <p style="color:red;">לא הוגדר קישור RSS בעמוד זה.</p>
    return;
  }



  List<Episode> episodes = new List<Episode>();

  using (var client = new System.Net.WebClient())
  {
    try
    {
      var xml = client.DownloadString(rssUrl);
      var doc = XDocument.Parse(xml);
      var items = doc.Descendants("item");

      episodes = items.Select(item => new Episode
      {
        Title = item.Element("title")?.Value,
        Description = CleanDescription(item.Element("description")?.Value),
        PubDate = item.Element("pubDate")?.Value,
        Image = item.Descendants().FirstOrDefault(x => x.Name.LocalName == "image")?.Attribute("href")?.Value,
        AudioUrl = item.Element("enclosure")?.Attribute("url")?.Value,
        Guid = item.Element("guid")?.Value,
        ProgramId = Model.Id
      }).ToList();
    }
    catch (Exception ex)
    {
      <p style="color:red;">שגיאה בטעינת ה-RSS: @ex.Message</p>
    }
  }

  var bannerImage = Model.Value<IPublishedContent>("rectangleImage");
  var bannerUrl = bannerImage?.Url();

  var dis = Model.Value<string>("discreption");
}

@if (!string.IsNullOrWhiteSpace(bannerUrl))
{
  <div class="banner-container">
    <img src="@bannerUrl" alt="Banner" class="banner-image" />
  </div>
}

<div class="program-header">
  <div class="program-title">
    <h1>@Model.Name</h1>
  </div>

  <div style="display: flex; align-items: center; gap: 15px;">

    <div class="tooltip-container">
      <button class="button-content" id="share-button">
        <span class="text">לחצו לשיתוף</span>
        <svg class="share-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
          <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 
              1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 
              3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 
              2.92-2.92c0-1.61-1.31-2.92-2.92-2.92z" />
        </svg>
      </button>

      <div class="tooltip-content" id="share-tooltip">
        <div class="tooltip-arrow"></div>
        <div class="social-icons">
          <a href="#" class="social-icon twitter" onclick="shareTo('twitter')">
            <i class="fa-brands fa-twitter"></i>
          </a>
          <a href="#" class="social-icon whatsapp" onclick="shareTo('whatsapp')">
            <i class="fa-brands fa-whatsapp"></i>
          </a>
          <a href="#" class="social-icon facebook" onclick="shareTo('facebook')">
            <i class="fa-brands fa-facebook"></i>
          </a>
        </div>
      </div>
    </div>

    <button id="favorite-btn" style="font-size:30px; background:none; border:none; cursor:pointer;">
      <i class="fa-regular fa-heart" id="favorite-icon"></i>
    </button>

  </div>
</div>

<script>
  const tooltip = document.getElementById("share-tooltip");
  const button = document.getElementById("share-button");

  button.addEventListener("click", function (e) {
    e.stopPropagation(); // שלא יסגר מיד
    tooltip.style.display = tooltip.style.display === "block" ? "none" : "block";
  });

  document.addEventListener("click", function (e) {
    if (!tooltip.contains(e.target) && e.target !== button) {
      tooltip.style.display = "none";
    }
  });

  function shareTo(platform) {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent(document.title);
    let shareUrl = "";

    switch (platform) {
      case "twitter":
        shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${text}`;
        break;
      case "facebook":
        shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
        break;
      case "whatsapp":
        shareUrl = `https://wa.me/?text=${text}%20${url}`;
        break;
    }

    window.open(shareUrl, "_blank", "width=600,height=400");
  }
</script>

<div class="m-3 richtext-container">
  @Html.Raw(FormatDescription(@dis))
</div>

<hr />

@if (!episodes.Any())
{
  <p>לא נמצאו פרקים להצגה.</p>
}
else
{
  <div class="episode-list" id="episodes-container">
    @foreach (var episode in episodes.Take(8))
    {
      var dateString = episode.PubDate;
      DateTime pubDate;
      var formattedDate = DateTime.TryParse(dateString, out pubDate)
      ? pubDate.ToString("dd.MM.yy")
      : dateString;

      <div class="episode-card">
        <div class="episode-image-container">
          @if (!string.IsNullOrEmpty(episode.Image))
          {
            <img src="@episode.Image" alt="@episode.Title" />
          }
          <a href="/episode?guid=@episode.Guid&programId=@Model.Id" class="play-button">
            <i class="fa-solid fa-circle-play"></i>
          </a>
        </div>
        <div class="episode-info">
          <h4>@episode.Title</h4>
          <p class="description" style="direction:rtl;">@episode.Description</p>
          <p class="date">@formattedDate</p>
        </div>
      </div>
    }
  </div>

  @if (episodes.Count > 8)
  {
    <button id="load-more">
      טען עוד
      <i class="fa-solid fa-chevron-down"></i>
    </button>
  }
}

<script>
  const allEpisodes = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(episodes));
  let displayedCount = 8;

  document.querySelectorAll('.episode-card').forEach((card, index) => {
    setTimeout(() => card.classList.add('show'), 50 * (index + 1));
  });

  const loadMoreButton = document.getElementById('load-more');

  if (!loadMoreButton || allEpisodes.length <= displayedCount) {
    if (loadMoreButton) loadMoreButton.style.display = 'none';
  } else {
    loadMoreButton.addEventListener('click', function () {
      const container = document.getElementById('episodes-container');
      const nextEpisodes = allEpisodes.slice(displayedCount, displayedCount + 8);

      nextEpisodes.forEach((ep, index) => {
        const pubDate = new Date(ep.PubDate);
        const formattedDate = !isNaN(pubDate)
          ? pubDate.toLocaleDateString('he-IL')
          : ep.PubDate;

        const card = document.createElement('div');
        card.classList.add('episode-card');
        card.innerHTML = `
                    <div class="episode-image-container">
                        ${ep.Image ? `<img src="${ep.Image}" alt="${ep.Title}" />` : ''}
                        <a href="/episode?guid=${ep.Guid}&programId=${ep.ProgramId}" class="play-button">
                           <i class="fa-solid fa-circle-play"></i>
                        </a>
                    </div>
                    <div class="episode-info">
                        <h4>${ep.Title}</h4>
                        <p class="description">${ep.Description || ''}</p>
                        <p class="date">${formattedDate}</p>
                    </div>
                `;

        container.appendChild(card);
        setTimeout(() => card.classList.add('show'), 50 * (index + 1));
      });

      displayedCount += 8;

      if (displayedCount >= allEpisodes.length) {
        loadMoreButton.style.display = 'none';
      }
    });
  }

</script>

<script>
  const programId = @Model.Id; // מזהה התכנית
  const programName = "@Model.Name";
  const programImage = "@(Model.Value<IPublishedContent>("squareImage")?.Url() ?? "")";
  const programUrl = "@Model.Url()";

  // טען את רשימת המועדפים מה-LocalStorage
  let favorites = JSON.parse(localStorage.getItem("favoritePrograms") || "[]");

  const favoriteBtn = document.getElementById("favorite-btn");
  const favoriteIcon = document.getElementById("favorite-icon");

  // בדוק אם התכנית כבר במועדפים
  if (favorites.find(p => p.id === programId)) {
    favoriteIcon.classList.remove("fa-regular");
    favoriteIcon.classList.add("fa-solid");
    favoriteIcon.classList.add("favorited");
  }

  favoriteBtn.addEventListener("click", () => {
    const index = favorites.findIndex(p => p.id === programId);

    if (index === -1) {
      // הוסף למועדפים
      favorites.push({ id: programId, name: programName, image: programImage, urlProgram: programUrl });
      favoriteIcon.classList.remove("fa-regular");
      favoriteIcon.classList.add("fa-solid", "favorited");

    } else {
      // הסר מהמועדפים
      favorites.splice(index, 1);
      favoriteIcon.classList.remove("fa-solid", "favorited");
      favoriteIcon.classList.add("fa-regular");
    }

    localStorage.setItem("favoritePrograms", JSON.stringify(favorites));
  });


</script>
