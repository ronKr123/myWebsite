@using System.Xml.Linq
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    body {
        margin: 0;
        padding: 0;
        height: 100vh;
        background-image: url('/media/oqbnvw4h/backimg.png');
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        background-attachment: fixed;
    }

    .episode-container {
        text-align: center;
        margin: 20px auto;
        max-width: 800px;
    }

    .episode-image {
        max-width: 400px;
        display: block;
        margin: 20px auto;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .episode-description {
        margin-top: 20px;
        text-align: right;
        direction: rtl;
        font-size: 18px;
    }

    .nav-buttons {
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
    }

    .nav-buttons a {
        font-size: 16px;
        color: blue;
        text-decoration: none;
    }

    .program-link {
        display: block;
        margin-top: 20px;
        font-size: 16px;
        color: blue;
        text-decoration: none;
    }

    .more-episodes {
        margin-top: 40px;
    }

    .episode-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-top: 10px;
    }

    .episode-card {
        border: 1px solid #ccc;
        padding: 10px;
        position: relative;
        border-radius: 8px;
        background: white;
    }

    .episode-card img {
        width: 100%;
        border-radius: 8px;
    }

    .play-button {
        position: absolute;
        bottom: 10px;
        left: 10px;
        font-size: 40px;
        color: white;
        text-decoration: none;
    }
</style>

@functions {
    public class Episode
    {
        public string Title { get; set; }
        public string PubDate { get; set; }
        public string Image { get; set; }
        public string AudioUrl { get; set; }
        public string Description { get; set; }
        public string Guid { get; set; }
    }
}

@{
    Layout = "master.cshtml";

    var guid = Context.Request.Query["guid"].ToString();
    var programIdStr = Context.Request.Query["programId"].ToString();

    if (!int.TryParse(programIdStr, out int programId))
    {
        <p style="color:red;">לא התקבל מזהה תוכנית תקין ב-URL.</p>
        return;
    }

    var programPage = Umbraco.Content(programId);
    if (programPage == null)
    {
        <p style="color:red;">לא נמצא עמוד תוכנית עם מזהה זה.</p>
        return;
    }

    var rssLinks = programPage.Value<IEnumerable<Umbraco.Cms.Core.Models.Link>>("rssLink2");
    var rssUrl = rssLinks?.FirstOrDefault()?.Url;

    if (string.IsNullOrEmpty(rssUrl))
    {
        <p style="color:red;">לא הוגדר קישור RSS בעמוד התוכנית.</p>
        return;
    }

    List<Episode> episodes = new List<Episode>();
    try
    {
        using (var client = new System.Net.WebClient())
        {
            var xml = client.DownloadString(rssUrl);
            var doc = XDocument.Parse(xml);
            var items = doc.Descendants("item");

            episodes = items.Select(item => new Episode
            {
                Title = item.Element("title")?.Value,
                PubDate = item.Element("pubDate")?.Value,
                Image = item.Descendants().FirstOrDefault(x => x.Name.LocalName == "image")?.Attribute("href")?.Value,
                AudioUrl = item.Element("enclosure")?.Attribute("url")?.Value,
                Description = item.Element("description")?.Value,
                Guid = item.Element("guid")?.Value
            }).ToList();
        }
    }
    catch (Exception ex)
    {
        <p style="color:red;">שגיאה בטעינת ה-RSS: @ex.Message</p>
        return;
    }

    var episodeIndex = episodes.FindIndex(e => e.Guid == guid);
    if (episodeIndex == -1)
    {
        <p style="color:red;">פרק לא נמצא.</p>
        return;
    }

    var episode = episodes[episodeIndex];
    var previousEpisode = episodeIndex > 0 ? episodes[episodeIndex - 1] : null;
    var nextEpisode = episodeIndex < episodes.Count - 1 ? episodes[episodeIndex + 1] : null;
}

<div class="episode-container">
    <h1>@episode.Title</h1>
    <p>@episode.PubDate</p>

    @if (!string.IsNullOrEmpty(episode.Image))
    {
        <img src="@episode.Image" alt="@episode.Title" class="episode-image" />
    }

    <div class="episode-description">
        @Html.Raw(episode.Description)
    </div>

    @if (!string.IsNullOrEmpty(episode.AudioUrl))
    {
        <audio controls style="margin-top: 20px; width: 100%;">
            <source src="@episode.AudioUrl" type="audio/mpeg" />
            הדפדפן שלך לא תומך בהשמעת אודיו.
        </audio>
    }

    <div class="nav-buttons">
        @if (previousEpisode != null)
        {
            <a href="/episode?guid=@previousEpisode.Guid&programId=@programPage.Id">« פרק קודם</a>
        }
        else { <span></span> }

        @if (nextEpisode != null)
        {
            <a href="/episode?guid=@nextEpisode.Guid&programId=@programPage.Id">פרק הבא »</a>
        }
    </div>

    <a href="@programPage.Url()" class="program-link">← חזרה לעמוד התוכנית</a>

</div>

<div class="more-episodes">
    <h3 style="text-align:right; direction:rtl;">פרקים נוספים מהתוכנית:</h3>
    <div class="episode-grid">
        @foreach (var ep in episodes.Where(e => e.Guid != episode.Guid).Take(4))
        {
            var pubDate = DateTime.TryParse(ep.PubDate, out var date)
                ? date.ToString("dd.MM.yy")
                : ep.PubDate;

            <div class="episode-card">
                @if (!string.IsNullOrEmpty(ep.Image))
                {
                    <img src="@ep.Image" alt="@ep.Title" />
                }
                <h4 style="text-align:right;">@ep.Title</h4>
                <h5 style="text-align:right;">@pubDate</h5>
                <a href="/episode?guid=@ep.Guid&programId=@programPage.Id" class="play-button">
                    <i class="fa-solid fa-play-circle"></i>
                </a>
            </div>
        }
    </div>
</div>
